{% extends 'base.html' %}
{% block title %}Tasks{% endblock %}
{% block content %}
<h1 class="mb-4">{% if can_assign %}All Users' Tasks{% else %}{{ user }}'s Tasks{% endif %}</h1>
<p class="text-muted">Role: {{ role }} | Branches: {{ branches | join(', ') }}</p>

{% if can_assign %}
  <div class="row">
    {% for uname, udata in all_users.items() %}
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header">{{ uname }}'s Tasks</div>
          <ul class="list-group list-group-flush task-list" data-user="{{ uname }}">
            {% if udata['tasks'] %}
              {% for task in udata['tasks'] %}
              <li class="list-group-item task-item {{ task | overdue_class }}" draggable="true" data-user="{{ uname }}" data-index="{{ loop.index0 }}">
                <form method="post" class="d-flex justify-content-between align-items-center">
                  <span><a href="{{ url_for('task_detail', user=uname, index=loop.index0) }}">{{ task['description'] }}</a> <small class="text-muted ms-2">Due {{ task.get('due_date', 'N/A') }}</small></span>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge {{ task['priority'] | priority_class }}">{{ task['priority'] }}</span>
                    <select name="status" class="form-select form-select-sm" {% if uname != user %}disabled{% endif %}>
                      <option value="Incomplete" {% if task['status'] == 'Incomplete' %}selected{% endif %}>Incomplete</option>
                      <option value="Doing" {% if task['status'] == 'Doing' %}selected{% endif %}>Doing</option>
                      <option value="Done" {% if task['status'] == 'Done' %}selected{% endif %}>Done</option>
                    </select>
                    {% if uname == user %}
                    <input type="hidden" name="task_index" value="{{ loop.index0 }}">
                    <input type="hidden" name="user" value="{{ uname }}">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                    {% endif %}
                  </div>
                </form>
                <form method="post" class="d-flex align-items-center mt-2">
                  <input type="hidden" name="task_index" value="{{ loop.index0 }}">
                  <input type="hidden" name="user" value="{{ uname }}">
                  <select name="reassign" class="form-select form-select-sm">
                    {% for uname2 in all_users.keys() if uname2 != uname %}
                    <option value="{{ uname2 }}">{{ uname2 }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-sm btn-outline-secondary ms-2">Reassign</button>
                </form>

              </li>
              {% endfor %}
            {% else %}
              <li class="list-group-item text-muted">No tasks</li>
            {% endif %}
          </ul>
        </div>
      </div>
    {% endfor %}
  </div>
  <div class="card mt-4">
    <div class="card-header">Add Task</div>
    <div class="card-body">
      <form method="post" class="row gy-2 gx-3 align-items-center">
        <div class="col-sm-3">
          <input type="text" name="task" class="form-control" placeholder="New task" required>
        </div>
        <div class="col-sm-2">
          <select name="priority" class="form-select">
            <option value="High">High</option>
            <option value="Mid" selected>Mid</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <div class="col-sm-3">
          <select name="assignee" class="form-select">
            {% for uname in all_users.keys() %}
            <option value="{{ uname }}">{{ uname }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-2">
          <input type="date" name="due_date" class="form-control">
        </div>
        <div class="col-sm-2">
          <button type="submit" class="btn btn-success w-100">Add</button>
        </div>
      </form>
    </div>
  </div>
{% else %}
  <div class="card mb-4">
    <div class="card-header">Performance</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <canvas id="completionChart"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="card mb-4">
    <div class="card-header">Your Tasks</div>
    <ul class="list-group list-group-flush" data-user="{{ user }}">
      {% for task in tasks %}
      <li class="list-group-item {{ task | overdue_class }}">
        <form method="post" class="d-flex justify-content-between align-items-center">
          <span><a href="{{ url_for('task_detail', user=user, index=loop.index0) }}">{{ task['description'] }}</a> <small class="text-muted ms-2">Due {{ task.get('due_date', 'N/A') }}</small></span>
          <div class="d-flex align-items-center gap-2">
            <span class="badge {{ task['priority'] | priority_class }}">{{ task['priority'] }}</span>
            <select name="status" class="form-select form-select-sm">
              <option value="Incomplete" {% if task['status'] == 'Incomplete' %}selected{% endif %}>Incomplete</option>
              <option value="Doing" {% if task['status'] == 'Doing' %}selected{% endif %}>Doing</option>
              <option value="Done" {% if task['status'] == 'Done' %}selected{% endif %}>Done</option>
            </select>
            <input type="hidden" name="task_index" value="{{ loop.index0 }}">
            <input type="hidden" name="user" value="{{ user }}">
            <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
          </div>
        </form>

      </li>
      {% endfor %}
      {% if not tasks %}
      <li class="list-group-item text-muted">No tasks</li>
      {% endif %}
    </ul>
  </div>
  <div class="card mb-4">
    <div class="card-header">Past Tasks</div>
    <ul class="list-group list-group-flush">
      {% for task in past_tasks %}
      <li class="list-group-item">
        <span>{{ task['description'] }}</span>
        <span class="badge {{ task['priority'] | priority_class }}">{{ task['priority'] }}</span>
        <small class="text-muted ms-2">Due {{ task.get('due_date', 'N/A') }}</small>
      </li>
      {% endfor %}
      {% if not past_tasks %}
      <li class="list-group-item text-muted">No past tasks</li>
      {% endif %}
    </ul>
  </div>
  <div class="card">
    <div class="card-header">Add Task</div>
    <div class="card-body">
      <form method="post" class="row gy-2 gx-3 align-items-center">
        <div class="col-sm-5">
          <input type="text" name="task" class="form-control" placeholder="New task" required>
        </div>
        <div class="col-sm-2">
          <select name="priority" class="form-select">
            <option value="High">High</option>
            <option value="Mid" selected>Mid</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <div class="col-sm-3">
          <input type="date" name="due_date" class="form-control">
        </div>
        <div class="col-sm-2">
          <button type="submit" class="btn btn-success w-100">Add</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    const stats = {{ stats | tojson }};
    const trend = {{ trend | tojson }};
    new Chart(document.getElementById('completionChart'), {
      type: 'pie',
      data: {
        labels: ['Done', 'Pending'],
        datasets: [{
          data: [stats.done, stats.pending],
          backgroundColor: ['#198754', '#dc3545']
        }]
      }
    });
    new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: {
        labels: trend.map(t => t.date),
        datasets: [
          {
            label: 'Created',
            data: trend.map(t => t.created),
            borderColor: '#0d6efd',
            fill: false
          },
          {
            label: 'Done',
            data: trend.map(t => t.done),
            borderColor: '#198754',
            fill: false
          }
        ]
      }
    });
  </script>
{% endif %}
{% endblock %}

